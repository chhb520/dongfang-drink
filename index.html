<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>东方树叶三得利价格计算器</title>
  <style>
    :root{
      --bg:#fdfdfd;--card:#ffffff;--muted:#555;--text:#111;--accent:#007bff;--ok:#26c281;--warn:#ff6b6b;
      --border-light:rgba(0,0,0,.06);--border-dark:rgba(255,255,255,.06);
      --shadow-light:rgba(0,0,0,.1);--shadow-dark:rgba(0,0,0,.35);
      --font-family: "PingFang SC","Hiragino Sans GB","Microsoft YaHei","SimSun",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
    }
    [data-theme="dark"]{
      --bg:#0b1020;--card:#121a33;--muted:#93a0b2;--text:#eaf1ff;--accent:#4da3ff;--ok:#26c281;--warn:#ff5c5c;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.6 var(--font-family);transition:.3s background,.3s color;-webkit-text-size-adjust:100%;touch-action:manipulation}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    h1{font-size:clamp(18px,5vw,28px);letter-spacing:.5px;margin:0 0 10px;line-height:1.2}
    .sub{color:var(--muted);margin-bottom:20px;font-size:14px;line-height:1.5}
    .card{background:var(--card);border:1px solid var(--border-light);border-radius:18px;box-shadow:0 10px 30px var(--shadow-light);overflow:hidden;transition:.3s all}
    [data-theme="dark"] .card{border:1px solid var(--border-dark);box-shadow:0 10px 30px var(--shadow-dark)}
    .row{display:grid;grid-template-columns:120px 1fr 1fr 1fr 1fr 1fr;gap:8px;align-items:center;min-height:60px}
    .head{padding:12px 16px;background:rgba(0,0,0,.03);position:sticky;top:0;backdrop-filter:blur(8px);z-index:10}
    [data-theme="dark"] .head{background:rgba(255,255,255,.03)}
    .body{padding:8px 16px;display:grid;gap:6px}
    .row>div,.row>label{padding:8px 6px;font-size:14px}
    .row.head>div{font-weight:600;color:var(--accent);font-size:13px}
    .size{font-weight:600;font-size:14px;line-height:1.2}
    .field{display:flex;gap:4px;align-items:center;justify-content:center}
    
    /* 输入框背景和边框增强样式 */
    .input-field {
      position: relative;
      background: linear-gradient(135deg, rgba(0,123,255,0.08), rgba(0,123,255,0.04));
      border: 2px solid rgba(0,123,255,0.2);
      border-radius: 10px;
      padding: 1px;
      transition: all 0.3s ease;
      max-width: 85px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    [data-theme="dark"] .input-field {
      background: linear-gradient(135deg, rgba(77,163,255,0.12), rgba(77,163,255,0.06));
      border: 2px solid rgba(77,163,255,0.3);
    }
    
    .input-field:hover {
      border-color: rgba(0,123,255,0.4);
      background: linear-gradient(135deg, rgba(0,123,255,0.12), rgba(0,123,255,0.06));
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,123,255,0.15);
    }
    
    [data-theme="dark"] .input-field:hover {
      border-color: rgba(77,163,255,0.5);
      background: linear-gradient(135deg, rgba(77,163,255,0.18), rgba(77,163,255,0.08));
      box-shadow: 0 4px 12px rgba(77,163,255,0.2);
    }
    
    .input-field.focused {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(0,123,255,0.15), rgba(0,123,255,0.08));
      box-shadow: 0 0 0 3px rgba(0,123,255,0.1), 0 6px 16px rgba(0,123,255,0.2);
      transform: translateY(-2px);
    }
    
    [data-theme="dark"] .input-field.focused {
      background: linear-gradient(135deg, rgba(77,163,255,0.2), rgba(77,163,255,0.1));
      box-shadow: 0 0 0 3px rgba(77,163,255,0.15), 0 6px 16px rgba(77,163,255,0.25);
    }
    
    input[type="number"]{width:100%;padding:8px 6px;border-radius:8px;border:none;background:transparent;color:var(--text);transition:.2s all;font-size:14px;-webkit-appearance:none;appearance:none;font-weight:500;text-align:center;font-family:var(--font-family)}
    input[type="number"]:focus{outline:none}
    input[type="number"]:invalid{color:var(--warn)}
    [data-theme="dark"] input[type="number"]{color:var(--text)}
    
    /* 确保所有列的内容都居中对齐 */
    .row > div:nth-child(2),  /* 总价列 */
    .row > div:nth-child(3),  /* 瓶数列 */
    .row > div:nth-child(4),  /* 每瓶列 */
    .row > div:nth-child(5),  /* 每毫升列 */
    .row > div:nth-child(6) { /* 每升列 */
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    
    /* 非输入字段的普通样式 */
    select{width:100%;padding:10px 8px;border-radius:10px;border:2px solid var(--border-light);background:#fff;color:var(--text);transition:.2s all;font-size:14px;-webkit-appearance:none;appearance:none;text-align:left;font-family:var(--font-family)}
    select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(77,163,255,.2)}
    [data-theme="dark"] select{background:#0e152b;border:2px solid var(--border-dark);color:var(--text)}
    
    /* 货币符号特殊处理 */
    .currency-symbol {
      font-family: "SimSun", "宋体", "Microsoft YaHei", serif;
      font-weight: normal;
    }
    
    .unit{opacity:.7;font-size:11px;white-space:nowrap}
    .muted{color:var(--muted)}
    
    /* 统一的控制栏布局 */
    .controls{margin:16px 0}
    .controls-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:center;
      align-items:center;
    }
    
    /* 货币选择器样式 */
    .currency-selector{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding:8px 12px;
      border-radius:10px;
      background:rgba(0,0,0,.06);
      border:2px solid var(--border-light);
      font-size:14px;
      min-height:44px;
      flex-shrink:0;
    }
    [data-theme="dark"] .currency-selector{background:rgba(255,255,255,.06);border:2px solid var(--border-dark)}
    
    .currency-selector select{
      padding:4px 6px;
      font-size:14px;
      min-height:auto;
      border:none;
      background:transparent;
      width:auto;
      min-width:80px;
    }
    
    button{cursor:pointer;border:2px solid var(--border-light);background:#fff;color:var(--text);padding:10px 14px;border-radius:10px;transition:.2s all;font-size:14px;min-height:44px;touch-action:manipulation;-webkit-tap-highlight-color:transparent;font-family:var(--font-family);white-space:nowrap;flex-shrink:0}
    button:hover,button:active{border-color:var(--accent);background:rgba(0,123,255,.05);transform:translateY(0)}
    [data-theme="dark"] button{background:#0e152b;border:2px solid var(--border-dark);color:var(--text)}
    [data-theme="dark"] button:hover,[data-theme="dark"] button:active{background:rgba(77,163,255,.1)}
    
    /* 特殊按钮样式 */
    .add-custom{background:var(--ok);color:#fff;border:2px solid var(--ok)}
    .add-custom:hover{background:rgba(38,194,129,.9);border-color:var(--ok)}
    
    .footer{display:flex;flex-direction:column;gap:12px;padding:14px 16px;color:var(--muted);border-top:1px dashed var(--border-light)}
    [data-theme="dark"] .footer{border-top:1px dashed var(--border-dark)}
    .footer-formula{font-size:12px;text-align:center}
    .kpi{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .highlight-card{
      padding:10px 14px;
      border-radius:12px;
      font-weight:700;
      font-size:13px;
      box-shadow:0 3px 8px rgba(0,0,0,.15);
      transition:.2s transform;
      text-align:center;
      flex:1;
      min-width:120px;
    }
    .highlight-card:active{transform:scale(0.98)}
    .highlight-best{background:var(--ok);color:#fff;}
    .highlight-worst{background:var(--warn);color:#fff;}
    .summary{margin-top:24px;padding:16px;border-radius:16px;background:rgba(0,0,0,.05);border:1px dashed var(--border-light);font-size:14px}
    [data-theme="dark"] .summary{background:rgba(255,255,255,.05);border:1px dashed var(--border-dark)}
    .summary h3{margin:0 0 12px;font-size:16px}
    a{color:var(--accent);text-decoration:none}
    .toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-100%);background:var(--card);border:2px solid var(--border-light);border-radius:12px;padding:12px 16px;box-shadow:0 4px 12px var(--shadow-light);z-index:1000;transition:.3s transform;max-width:90vw;text-align:center;font-family:var(--font-family)}
    .toast.show{transform:translateX(-50%) translateY(0)}
    [data-theme="dark"] .toast{border:2px solid var(--border-dark);box-shadow:0 4px 12px var(--shadow-dark)}
    .custom-row{border:2px dashed var(--accent);border-radius:12px;padding:8px;margin:4px 0}
    .remove-btn{background:var(--warn);color:#fff;border:none;padding:8px 12px;border-radius:8px;font-size:12px;margin-left:4px;min-height:40px;touch-action:manipulation;font-family:var(--font-family)}
    
    /* 手机专用优化 */
    @media (max-width: 800px){
      .wrap{margin:16px auto;padding:0 12px}
      h1{font-size:20px;margin-bottom:8px}
      .sub{font-size:13px;margin-bottom:16px}
      .row{grid-template-columns:90px 1fr 1fr 1fr 1fr;gap:6px;min-height:50px}
      .perL{display:none!important}
      .head{padding:10px 12px}
      .body{padding:6px 12px}
      .row>div,.row>label{padding:6px 4px;font-size:13px}
      .row.head>div{font-size:12px}
      .size{font-size:11px}
      
      .input-field {
        max-width: 70px;
        padding: 1px;
        border-radius: 8px;
      }
      
      input[type="number"]{padding:8px 4px;font-size:14px;border-radius:6px}
      
      .unit{font-size:10px}
      .controls{margin:12px 0}
      
      /* 移动端控制按钮布局 */
      .controls-row{
        flex-direction:column;
        align-items:stretch;
        gap:8px;
      }
      
      .controls-row > *{
        width:100%;
        justify-content:center;
        text-align:center;
      }
      
      .currency-selector{
        justify-content:center;
        text-align:center;
        padding:10px 12px;
      }
      
      .currency-selector select{
        text-align:center;
        width:100%;
      }
      
      button{padding:12px;font-size:13px;border-radius:8px}
      .kpi{gap:6px}
      .highlight-card{padding:8px 10px;font-size:12px;min-width:100px}
      .footer{padding:12px}
      .footer-formula{font-size:11px}
      .summary{padding:12px;font-size:13px;margin-top:16px}
      .summary h3{font-size:15px;margin-bottom:8px}
      .toast{top:10px;left:10px;right:10px;transform:translateY(-100%);max-width:none}
      .toast.show{transform:translateY(0)}
    }
    
    @media (max-width: 500px){
      .wrap{padding:0 8px}
      .row{grid-template-columns:80px 1fr 1fr 1fr 1fr;gap:4px}
      .row>div,.row>label{padding:4px 2px;font-size:12px}
      .size{font-size:10px}
      
      .input-field {
        max-width: 60px;
      }
      
      input[type="number"]{padding:6px 3px;font-size:14px}
      .controls-row{gap:6px}
      button{padding:10px 8px;font-size:12px;min-height:40px}
      .remove-btn{padding:6px 8px;min-height:36px}
      .highlight-card{padding:6px 8px;font-size:11px;min-width:80px}
      .kpi{gap:4px}
      
      .currency-selector{
        padding:8px 10px;
        min-height:40px;
      }
      
      .currency-selector select{
        font-size:12px;
      }
    }
    
    /* 中等屏幕优化 */
    @media (max-width: 1000px) and (min-width: 801px){
      .controls-row{
        gap:6px;
      }
      
      button{
        padding:8px 12px;
        font-size:13px;
      }
      
      .currency-selector{
        padding:6px 10px;
      }
      
      .currency-selector select{
        font-size:13px;
        min-width:70px;
      }
    }
    
    /* 横屏优化 */
    @media (max-width: 800px) and (orientation: landscape){
      .wrap{margin:8px auto}
      h1{font-size:18px;margin-bottom:6px}
      .sub{margin-bottom:12px}
      .controls{margin:8px 0}
      .controls-row{flex-direction:row;flex-wrap:wrap;justify-content:center}
      .controls-row > *{width:auto;flex:0 0 auto}
      .summary{margin-top:12px}
    }
    
    /* 减少动画（节省电量） */
    @media (prefers-reduced-motion: reduce){
      *{transition:none!important;animation:none!important}
    }
    
    /* 高对比度支持 */
    @media (prefers-contrast: high){
      input[type="number"],select,button{border-width:3px}
    }
    
    /* 触摸目标优化 */
    input,button,select{min-height:44px}
    @media (pointer: coarse){
      input,button,select{min-height:48px}
    }
    
    /* 防止缩放时布局错乱 */
    .row{overflow-x:auto}
    
    /* iOS Safari 优化 */
    input[type="number"]{-webkit-appearance:none;-moz-appearance:textfield}
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
    
    /* 键盘弹出时的优化 */
    @media (max-height: 500px){
      .summary{display:none}
      .footer-formula{display:none}
    }
  </style>
</head>
<body data-theme="light">
  <div class="wrap">
    <h1>东方树叶三得利价格计算器</h1>
    <div class="sub">输入总价与瓶数，自动计算单价并标记最划算容量。建议每升<strong>≤5.5元</strong>可冲。</div>

    <div class="controls">
      <div class="controls-row">
        <button id="addCustom" class="add-custom">➕ 自定义容量</button>
        <button id="demo">📝 示例</button>
        <button id="reset">🗑️ 清空</button>
        <button id="export">📤 导出</button>
        <button id="import">📥 导入</button>
        <button id="toggleTheme">🌙 主题</button>
        <div class="currency-selector">💰 
          <select id="currency">
            <option value="¥"><span class="currency-symbol">¥</span> 人民币</option>
            <option value="$">$ 美元</option>
            <option value="€">€ 欧元</option>
            <option value="£">£ 英镑</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card" role="table" aria-label="价格计算表">
      <div class="row head" role="row">
        <div class="size" role="columnheader">容量规格</div>
        <div role="columnheader">总价</div>
        <div role="columnheader">瓶数</div>
        <div role="columnheader">每瓶</div>
        <div role="columnheader">每毫升</div>
        <div class="perL" role="columnheader">每升</div>
      </div>
      <div class="body" id="rows"></div>
      <div class="footer">
        <div class="footer-formula">公式：每毫升单价 = 总价 ÷ (瓶数 × 容量ml)，每瓶价格 = 总价 ÷ 瓶数</div>
        <div class="kpi">
          <span id="bestBadge" class="highlight-card highlight-best">最划算：--</span>
          <span id="worstBadge" class="highlight-card highlight-worst">最贵：--</span>
        </div>
      </div>
    </div>

    <div class="summary" id="summaryBox">
      <h3>📊 购物总计</h3>
      <div id="summaryResult">请填写数据以查看总计结果。</div>
    </div>

    <p class="muted" style="margin-top:12px;font-size:12px;text-align:center">💡 数据自动保存到本地，仅比较单位毫升价格</p>
  </div>

  <input type="file" id="fileInput" accept=".json" style="display:none">

<script>
class PriceCalculator {
  constructor() {
    this.sizes = [
      {name:'东方树叶335ml', size:335},
      {name:'东方树叶500ml', size:500},
      {name:'三得利500ml', size:500},
      {name:'东方树叶900ml', size:900},
      {name:'三得利1250ml', size:1250},
      {name:'东方树叶1500ml', size:1500},
    ];
    
    this.state = new Map();
    this.customCounter = 0;
    this.debounceTimer = null;
    this.isMobile = window.innerWidth <= 800;
    
    this.elements = {
      rows: document.getElementById('rows'),
      currency: document.getElementById('currency'),
      bestBadge: document.getElementById('bestBadge'),
      worstBadge: document.getElementById('worstBadge'),
      summaryResult: document.getElementById('summaryResult'),
      fileInput: document.getElementById('fileInput')
    };
    
    this.init();
  }

  init() {
    this.createInitialRows();
    this.bindEvents();
    this.loadTheme();
    this.loadData();
    this.compute();
    this.handleResize();
  }

  handleResize() {
    window.addEventListener('resize', () => {
      this.isMobile = window.innerWidth <= 800;
    });
    
    // 处理键盘弹出
    let initialHeight = window.innerHeight;
    window.addEventListener('resize', () => {
      if (this.isMobile && window.innerHeight < initialHeight * 0.75) {
        document.body.classList.add('keyboard-open');
      } else {
        document.body.classList.remove('keyboard-open');
      }
    });
  }

  createInitialRows() {
    this.sizes.forEach(item => this.createRow(item));
  }

  createRow(item, isCustom = false) {
    const row = document.createElement('div');
    row.className = `row ${isCustom ? 'custom-row' : ''}`;
    row.setAttribute('data-size', isCustom ? 'custom' : item.size);

    const c0 = document.createElement('div');
    if (isCustom) {
      c0.innerHTML = `
        <div style="display:flex;align-items:center;gap:2px;flex-wrap:wrap">
          <input type="number" min="1" step="1" placeholder="ml" style="width:50px;flex:1;min-width:40px" title="输入容量(毫升)" inputmode="numeric">
          <button class="remove-btn" title="删除此行">×</button>
        </div>
      `;
    } else {
      const displayName = this.isMobile ? item.name.replace('东方树叶', '东方').replace('三得利', '三得') : item.name;
      c0.innerHTML = `<span class="size" title="${item.name}">${displayName}</span>`;
    }

    const priceWrap = this.createInputField('decimal', '12.90', '总价');
    const countWrap = this.createInputField('numeric', '6', '瓶数');

    const perBottle = document.createElement('div');
    const perMl = document.createElement('div');
    const perL = document.createElement('div'); 
    perL.className = 'perL';

    row.append(c0, priceWrap, countWrap, perBottle, perMl, perL);
    this.elements.rows.appendChild(row);

    const key = isCustom ? `custom-${++this.customCounter}` : `${item.name}-${item.size}`;
    const stateObj = {
      row,
      sizeInput: isCustom ? c0.querySelector('input[type="number"]') : null,
      size: item.size,
      price: priceWrap.querySelector('input'),
      count: countWrap.querySelector('input'),
      perBottle, perMl, perL
    };
    
    this.state.set(key, stateObj);

    // 绑定事件
    stateObj.price.addEventListener('input', () => this.debouncedCompute());
    stateObj.count.addEventListener('input', () => this.debouncedCompute());
    
    // 移动端优化：失焦时自动计算
    if (this.isMobile) {
      stateObj.price.addEventListener('blur', () => this.compute());
      stateObj.count.addEventListener('blur', () => this.compute());
    }
    
    if (isCustom) {
      stateObj.sizeInput.addEventListener('input', () => this.debouncedCompute());
      if (this.isMobile) {
        stateObj.sizeInput.addEventListener('blur', () => this.compute());
      }
      c0.querySelector('.remove-btn').addEventListener('click', () => this.removeCustomRow(key));
    }

    // 添加输入验证
    this.addInputValidation(stateObj.price);
    this.addInputValidation(stateObj.count);
    if (stateObj.sizeInput) this.addInputValidation(stateObj.sizeInput);

    return key;
  }

  createInputField(inputMode, placeholder, title) {
    const wrap = document.createElement('div');
    wrap.className = 'field input-field';
    const input = document.createElement('input');
    input.type = 'number';
    input.min = '0';
    // 修改step设置，允许任意小数位数
    input.step = inputMode === 'decimal' ? 'any' : '1';
    input.placeholder = placeholder;
    input.title = title;
    input.setAttribute('inputmode', inputMode);
    
    // 移动端防止缩放
    if (this.isMobile) {
      input.style.fontSize = '16px';
    }
    
    // 添加聚焦/失焦事件监听来切换样式
    input.addEventListener('focus', () => {
      wrap.classList.add('focused');
    });
    input.addEventListener('blur', () => {
      wrap.classList.remove('focused');
    });
    
    wrap.appendChild(input);
    return wrap;
  }

  addInputValidation(input) {
    input.addEventListener('blur', (e) => {
      const value = parseFloat(e.target.value);
      if (e.target.value && (!isFinite(value) || value < 0)) {
        e.target.classList.add('error');
        this.showToast('请输入有效的正数', 'error');
      } else {
        e.target.classList.remove('error');
        if (e.target.value) e.target.classList.add('success');
      }
    });

    input.addEventListener('input', (e) => {
      e.target.classList.remove('error', 'success');
    });
    
    // 移动端：数字键盘优化
    if (this.isMobile) {
      input.addEventListener('focus', (e) => {
        // 滚动到可见区域
        setTimeout(() => {
          e.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      });
    }
  }

  removeCustomRow(key) {
    const stateObj = this.state.get(key);
    if (stateObj && stateObj.row) {
      stateObj.row.remove();
      this.state.delete(key);
      this.debouncedCompute();
      this.saveData();
      this.showToast('已删除自定义行', 'success');
    }
  }

  bindEvents() {
    document.getElementById('addCustom').addEventListener('click', () => {
      this.createRow({name:'自定义', size:0}, true);
      this.saveData();
      this.showToast('已添加自定义行', 'success');
    });

    document.getElementById('reset').addEventListener('click', () => {
      this.resetAll();
    });

    document.getElementById('demo').addEventListener('click', () => this.loadDemo());
    document.getElementById('export').addEventListener('click', () => this.exportData());
    document.getElementById('import').addEventListener('click', () => this.elements.fileInput.click());
    document.getElementById('toggleTheme').addEventListener('click', () => this.toggleTheme());

    this.elements.currency.addEventListener('change', () => {
      this.compute();
      this.saveData();
    });

    this.elements.fileInput.addEventListener('change', (e) => this.importData(e));

    // 移动端：简化键盘快捷键
    if (!this.isMobile) {
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey || e.metaKey) {
          switch(e.key) {
            case 'r': e.preventDefault(); this.resetAll(); break;
            case 'd': e.preventDefault(); this.loadDemo(); break;
            case 's': e.preventDefault(); this.exportData(); break;
          }
        }
      });
    }
  }

  debouncedCompute() {
    clearTimeout(this.debounceTimer);
    const delay = this.isMobile ? 500 : 300; // 移动端延长防抖时间
    this.debounceTimer = setTimeout(() => {
      this.compute();
      this.saveData();
    }, delay);
  }

  formatMoney(value, precision = 4) {
    if (!isFinite(value)) return '--';
    const currency = this.elements.currency.value;
    return `${currency}${value.toFixed(precision)}`;
  }

  compute() {
    let best = {size: null, value: Infinity, name: ''};
    let worst = {size: null, value: -Infinity, name: ''};
    let totalPrice = 0;
    let totalMl = 0;
    let validEntries = 0;

    for (const [key, obj] of this.state.entries()) {
      const {sizeInput, size, price, count, perBottle, perMl, perL} = obj;
      const currentSize = sizeInput ? parseFloat(sizeInput.value) : size;
      const currentPrice = parseFloat(price.value);
      const currentCount = parseFloat(count.value);
      
      const isValid = isFinite(currentPrice) && isFinite(currentCount) && 
                     currentCount > 0 && isFinite(currentSize) && currentSize > 0;
      
      if (isValid) {
        const unitPrice = currentPrice / (currentCount * currentSize);
        const bottlePrice = currentPrice / currentCount;
        
        perBottle.innerHTML = `${this.formatMoney(bottlePrice, 2)} <span class="unit">/ 瓶</span>`;
        perMl.innerHTML = `${this.formatMoney(unitPrice)} <span class="unit">/ ml</span>`;
        
        const perLiterPrice = unitPrice * 1000;
        const isGoodDeal = perLiterPrice <= 5.5;
        const dealIcon = isGoodDeal ? '✅' : '';
        
        if (this.isMobile) {
          perL.innerHTML = `${this.formatMoney(perLiterPrice)} <span class="unit">/ L</span> ${dealIcon}`;
        } else {
          perL.innerHTML = `${this.formatMoney(perLiterPrice)} <span class="unit">/ 升</span> ${dealIcon}`;
        }

        if (unitPrice < best.value) {
          best = {size: currentSize, value: unitPrice, name: this.getSizeName(key)};
        }
        if (unitPrice > worst.value) {
          worst = {size: currentSize, value: unitPrice, name: this.getSizeName(key)};
        }
        
        totalPrice += currentPrice;
        totalMl += currentCount * currentSize;
        validEntries++;
      } else {
        perBottle.textContent = '--';
        perMl.textContent = '--';
        if (!this.isMobile) perL.textContent = '--';
      }
    }

    this.updateBadges(best, worst);
    this.updateSummary(totalPrice, totalMl, validEntries);
  }

  getSizeName(key) {
    if (key.startsWith('custom-')) return '自定义';
    const name = key.split('-')[0];
    return this.isMobile ? name.replace('东方树叶', '东方').replace('三得利', '三得') : name;
  }

  updateBadges(best, worst) {
    this.elements.bestBadge.textContent = best.size ? 
      `最划算：${best.name} (${this.formatMoney(best.value)}/ml)` : '最划算：--';
    
    this.elements.worstBadge.textContent = worst.size ? 
      `最贵：${worst.name} (${this.formatMoney(worst.value)}/ml)` : '最贵：--';
  }

  updateSummary(totalPrice, totalMl, validEntries) {
    if (totalPrice > 0 && totalMl > 0) {
      const avgUnitPrice = totalPrice / totalMl;
      const avgPerLiter = avgUnitPrice * 1000;
      const isGoodDeal = avgPerLiter <= 5.5;
      
      if (this.isMobile) {
        this.elements.summaryResult.innerHTML = `
          <div style="margin-bottom:6px">
            <strong>共 ${validEntries} 种商品</strong>
          </div>
          <div style="margin-bottom:6px">
            总计：${this.formatMoney(totalPrice, 2)} | ${(totalMl/1000).toFixed(1)}L
          </div>
          <div>
            平均：${this.formatMoney(avgPerLiter)} / 升 ${isGoodDeal ? '✅ 划算' : '⚠️ 偏贵'}
          </div>
        `;
      } else {
        this.elements.summaryResult.innerHTML = `
          <div style="margin-bottom:8px">
            <strong>本次购物统计：</strong>共 ${validEntries} 种商品
          </div>
          <div style="margin-bottom:8px">
            总金额：${this.formatMoney(totalPrice, 2)} | 总容量：${totalMl.toLocaleString()}ml
          </div>
          <div>
            平均单价：${this.formatMoney(avgUnitPrice)} / ml | 
            ${this.formatMoney(avgPerLiter)} / 升 ${isGoodDeal ? '✅ 划算' : '⚠️ 偏贵'}
          </div>
        `;
      }
    } else {
      this.elements.summaryResult.textContent = '请填写数据以查看总计结果。';
    }
  }

  resetAll() {
    // 删除所有自定义行
  for (const [key, obj] of this.state.entries()) {
      if (key.startsWith('custom-')) {
        obj.row.remove();
        this.state.delete(key);
      }
    }
    
    // 清空所有输入
    for (const {sizeInput, price, count} of this.state.values()) {
      if (sizeInput) sizeInput.value = '';
      price.value = '';
      count.value = '';
      price.classList.remove('error', 'success');
      count.classList.remove('error', 'success');
    }
    
    this.compute();
    this.saveData();
    this.showToast('已清空所有数据', 'success');
  }

  loadDemo() {
    const demo = {
      '东方树叶335ml-335': {price: 51.9, count: 24},
      '东方树叶500ml-500': {price: 48.0, count: 15},
      '三得利500ml-500': {price: 37.85, count: 15},
      '东方树叶900ml-900': {price: 57.0, count: 12},
      '三得利1250ml-1250': {price: 23.2, count: 4},
      '东方树叶1500ml-1500': {price: 50.4, count: 6},
    };

    for (const [key, obj] of this.state.entries()) {
      const {sizeInput, price, count} = obj;
      if (!key.startsWith('custom-')) {
        const demoData = demo[key];
        price.value = demoData?.price ?? '';
        count.value = demoData?.count ?? '';
      }
    }
    
    this.compute();
    this.saveData();
    this.showToast('已加载示例数据', 'success');
  }

  saveData() {
    try {
      const data = {
        currency: this.elements.currency.value,
        entries: {},
        customRows: []
      };

      for (const [key, obj] of this.state.entries()) {
        if (key.startsWith('custom-')) {
          data.customRows.push({
            size: obj.sizeInput ? obj.sizeInput.value : '',
            price: obj.price.value,
            count: obj.count.value
          });
        } else {
          data.entries[key] = {
            price: obj.price.value,
            count: obj.count.value
          };
        }
      }

      localStorage.setItem('priceCalculatorData', JSON.stringify(data));
    } catch (e) {
      console.warn('保存数据失败:', e);
    }
  }

  loadData() {
    try {
      const saved = localStorage.getItem('priceCalculatorData');
      if (!saved) return;

      const data = JSON.parse(saved);
      
      if (data.currency) {
        this.elements.currency.value = data.currency;
      }

      if (data.entries) {
        for (const [key, values] of Object.entries(data.entries)) {
          const obj = this.state.get(key);
          if (obj) {
            obj.price.value = values.price || '';
            obj.count.value = values.count || '';
          }
        }
      }

      if (data.customRows) {
        data.customRows.forEach(row => {
          const key = this.createRow({name:'自定义', size:0}, true);
          const obj = this.state.get(key);
          if (obj) {
            if (obj.sizeInput) obj.sizeInput.value = row.size || '';
            obj.price.value = row.price || '';
            obj.count.value = row.count || '';
          }
        });
      }
    } catch (e) {
      console.warn('加载数据失败:', e);
    }
  }

  exportData() {
    try {
      const data = {
        timestamp: new Date().toISOString(),
        currency: this.elements.currency.value,
        entries: {},
        customRows: []
      };

      for (const [key, obj] of this.state.entries()) {
        if (key.startsWith('custom-')) {
          data.customRows.push({
            size: obj.sizeInput ? obj.sizeInput.value : '',
            price: obj.price.value,
            count: obj.count.value
          });
        } else {
          data.entries[key] = {
            price: obj.price.value,
            count: obj.count.value
          };
        }
      }

      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `价格计算器数据_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      this.showToast('数据已导出', 'success');
    } catch (e) {
      this.showToast('导出失败', 'error');
    }
  }

  importData(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);
        
        this.resetAll();
        
        if (data.currency) {
          this.elements.currency.value = data.currency;
        }

        if (data.entries) {
          for (const [key, values] of Object.entries(data.entries)) {
            const obj = this.state.get(key);
            if (obj) {
              obj.price.value = values.price || '';
              obj.count.value = values.count || '';
            }
          }
        }

        if (data.customRows) {
          data.customRows.forEach(row => {
            const key = this.createRow({name:'自定义', size:0}, true);
            const obj = this.state.get(key);
            if (obj) {
              if (obj.sizeInput) obj.sizeInput.value = row.size || '';
              obj.price.value = row.price || '';
              obj.count.value = row.count || '';
            }
          });
        }

        this.compute();
        this.saveData();
        this.showToast('数据导入成功', 'success');
      } catch (e) {
        this.showToast('导入失败：文件格式错误', 'error');
      }
    };
    reader.readAsText(file);
    event.target.value = '';
  }

  toggleTheme() {
    const body = document.body;
    const currentTheme = body.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    body.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    
    const icon = newTheme === 'dark' ? '☀️' : '🌙';
    document.getElementById('toggleTheme').innerHTML = `${icon} 主题`;
  }

  loadTheme() {
    const saved = localStorage.getItem('theme');
    if (saved && ['light', 'dark'].includes(saved)) {
      document.body.setAttribute('data-theme', saved);
      const icon = saved === 'dark' ? '☀️' : '🌙';
      document.getElementById('toggleTheme').innerHTML = `${icon} 主题`;
    }
  }

  showToast(message, type = 'info') {
    const existingToast = document.querySelector('.toast');
    if (existingToast) existingToast.remove();

    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    
    if (type === 'error') toast.style.borderLeftColor = 'var(--warn)';
    else if (type === 'success') toast.style.borderLeftColor = 'var(--ok)';
    else toast.style.borderLeftColor = 'var(--accent)';
    
    document.body.appendChild(toast);
    
    setTimeout(() => toast.classList.add('show'), 10);
    
    // 移动端显示时间稍短
    const hideDelay = this.isMobile ? 2500 : 3000;
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, hideDelay);
  }
}

// 初始化应用
document.addEventListener('DOMContentLoaded', () => {
  new PriceCalculator();
});
</script>
</body>
</html>


